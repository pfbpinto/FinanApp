
CREATE OR REPLACE PROCEDURE CreateUser(
    IN p_FirstName VARCHAR(100),
    IN p_LastName VARCHAR(255),
	IN p_EmailAddress VARCHAR(255),
	IN p_UserPassword VARCHAR(150),
    IN p_DateOfBirth DATE,
    OUT p_Message TEXT
)
LANGUAGE plpgsql
AS $$
DECLARE
    existing_user INT;
BEGIN
    -- Verifica se algum campo obrigatório está nulo ou vazio
    IF TRIM(p_FirstName) = '' OR TRIM(p_LastName) = '' OR p_DateOfBirth IS NULL OR 
       TRIM(p_UserPassword) = '' OR TRIM(p_EmailAddress) = '' IS NULL THEN
        p_Message := '{"status": "fail", "message": "Todos os campos são obrigatórios."}';
        RETURN;
    END IF;

    -- Verifica se o e-mail já existe
    SELECT COUNT(*) INTO existing_user FROM UserProfile WHERE EmailAddress = p_EmailAddress;
    IF existing_user > 0 THEN
        p_Message := '{"status": "fail", "message": "O e-mail já está cadastrado."}';
        RETURN;
    END IF;

    -- Insere o novo usuário
    INSERT INTO UserProfile (FirstName, LastName, DateOfBirth, UserPassword, EmailAddress, UserSubscription)
    VALUES (p_FirstName, p_LastName, p_DateOfBirth, p_UserPassword, p_EmailAddress, '0');

    -- Retorna mensagem de sucesso
    p_Message := '{"status": "success", "message": "Usuário criado com sucesso."}';
END;
$$;